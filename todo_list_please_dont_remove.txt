
To-do list for SPECFEM3D_GLOBE, updated on January 21, 2007:
------------------------------------------------------------

Dimitri Komatitsch and David Michea
-----------------------------------

- supprimer NER_BOTTOMDBL_TOPDBL de constants.h (c'est un detail qui prend 5 minutes, Dimitri le fera demain)

- carefully study and improve stability condition and increase/adapt time step DT accordingly

- dire a Brian Savage (Washington D.C.) de faire un auto_NER a partir de PREM (choix automatique des parametres) a partir de display_prem_sampling_doubling.f90 dans DATA/util/mesh_doubling_superbrick

- enlever blocs AB, AC et BC partout, puisque tous les blocs sont maintenant de même type (*mais* il faudra quand même laisser les six noms : CHUNK_AB, CHUNK_AC, CHUNK_AB_ANTIPODE etc et garder les tests de type if(ichunk == CHUNK_AB_ANTIPODE) then partout où il y en a, car on continue à traiter 6 blocs, même s'ils ont maintenant la même topologie. Il faut donc conserver tout ce qui concerne ces six noms de blocs

- representer modele PREM, worst dispersion en OpenDX, worst stability en OpenDX comme dans code display_prem_sampling_doubling.f90 en serial sur le master seulement (rank == 0)

- enlever les "modules" et "use" partout où il y en a (pour anisotropie etc) car ce n'est pas "thread safe" et donc ça se plantera si on utilise MPC au lieu de MPI. Remplacer par la transmission explicite des paramètres aux subroutines. Peut-être dire dans le manuel utilisateur qu'il ne faut pas utiliser de modules pour cette raison ?

- supprimer write_AVS_mesh_quality, check_buffers*.f90, check_mesh_quality*.f90 etc une fois que le mesher et le solver auront été fusionnés (mettre à jour
le manuel en enlevant les deux sections expliquant l'utilisation de ces routines);
les enlever du Makefile.in aussi. Do not store x y z in the files that contain
the MPI buffers anymore, since they are used only by check_buffers*.
(in the solver they are read back as xdummy, ydummy, zdummy)

- add UPPA logo and name to frontpage of the manual, add David to the list of contributors, mention UPPA in the main text of the manual; also add UPPA to copyright info and to subroutine headers

- dire dans manuel que number of grid points per S wavelength (purposely) pas bon
dans le inner core, donc ne pas utiliser ce code pour étudier PKJKP ou bien
dans ce cas prendre un maillage prévu pour une période beaucoup plus courte
(typiquement deux fois) que la période mentionnée dans les tables, qui concerne
seulement les ondes P et non pas les S dans le inner core

- regarder consequences de multiple de 32 au lieu de 16 dans table 3.1 du manuel,
et refaire cette table en fonction de cette nouvelle contrainte. Mettre à jour
la Table 3.1 avec multiples de 32 au lieu de 16 et aussi en disant qu'on peut mettre 2 ou 3 ou 6 tâches par proc et donc que le nb de procs donnés peut être divisé par 2, 3 ou 6 et donc limitation moins grande qu'on ne pourrait le croire
(dire que c'est toujours divisible car NPROC = 6 N^2 donc divisible par 6); dire cela dans le texte principal du manuel et dans la légende de la table

- afficher les courbes de nombre de points par longueur d'onde et de stabilité et les worst elements (stability et nb pts per lambda) en OpenDX
en serial sur le maître dans le nouveau mesher, en copiant/collant ce qu'il faut depuis "DATA/util/doubling_brick/display_doubling_PREM*.f90); ajouter
ces courbes de dispersion et stabilité au manuel pour tous les NEX classiques (160, 256, 380 etc) dans un Appendix spécial là-dessus; dire dans cet
appendix que dans le outer core ce n'est bien sûr par Vs qui est représenté mais Vp / 1.25 (on a pris 25 % de marge car on travaille en velocity
potential dans le outer core, ce qui demande un échantillonnage un peu meilleur)

- use MPC in the code instead of MPI, if we can get MPC from CEA under GPL or CeCILL licence. Make sure the code is thread-safe (for instance
suppress all the modules and the "use" statements, which are not thread-safe)

- use indirect addressing to store anisotropy in the mantle to avoid having to
  start with that region, which breaks the Cuthill-McKee sorting; once this is
  done, suppress the statement in which we make this region become region number 1
  in the mesh creation routine

- merge the mesher in the solver, suppress storage of large mesh files on
  local disks, but make sure we keep the creation of AVS/OpenDX mesh files
  (which should be the case since we use specific routines called write_AVS_DX_*.f90)

- implement better (partly inflated) central cube

- remove bottleneck detected by ORNL in the MPI implementation of the central cube (many slices send to one processor, which creates
a big bottleneck)

- split central cube in 2 with MPI to have better load balancing there

- rewrite communications entirely (use clean non-blocking MPI communications, hide communications
  in calculations); see how to do this in the central cube, which is more
  difficult because it is in contact with many slices

- use persistent communications

- implement classical Cuthill-McKee sorting

- develop two-level Cuthill-McKee sorting for the two levels of cache with Jose Maria Cela (Barcelona)

- maybe use VMX/Altivec instructions in compute_forces*.f90 specifically for
  MareNostrum with Jose Maria Cela (Barcelona)

- run Sdiff calculations for Lev Vinnik (Moscow, Russia)

- run 3D PKP calculations for Sebastien Chevrot (Toulouse, France)

- modifier le calcul des bornes de l'attenuation: car
    MIN_ATTENUATION_PERIOD   = 20
    MAX_ATTENUATION_PERIOD   = 1000
est arbitraire dans read_compute_parameters.f90 actuellement,
il faudrait ecrire une routine plus generale avec Brian Savage un jour.
Voici son email et les miens à ce sujet :

Subject: Re: attenuation (other idea)
From: Dimitri Komatitsch <dimitri.komatitsch@univ-pau.fr>
Date: Sun, 21 Jan 2007 21:59:54 +0100
To: Brian Savage <savage@uri.edu>
CC: Jeroen Tromp <jtromp@gps.caltech.edu>, Qinya Liu <lqy@gps.caltech.edu>, Vala
Hjorleifsdottir <vala@gps.caltech.edu>, Ying Zhou <yingz@gps.caltech.edu>,
David Michéa <davidmichea@gmail.com>

Dear all,

Following Brian's tests described in his email below,
I think we should change the way we set the width of the
absorption band in read_parameters.f90. In the current implementation
we impose an arbitrary range, e.g. for NEX=160 we set:

    MIN_ATTENUATION_PERIOD   = 20
    MAX_ATTENUATION_PERIOD   = 1000

but of course we should replace this with some kind of automatic
range selection process based on the value of N_SLS (3, 4 or 5)
and on mesh resolution I guess.

Brian, if you have a way of adding this to the general 3D attenuation
routine you wrote, please do not hesitate to implement it
and get rid of the current arbitrary ranges... I think having
a flexible routine to do this would be very useful.

Dimitri.

Brian Savage wrote:
> Dear All,
>
> I will run some tests to determine the maximum width of the absorption band
> with 3,4 and 5 linear solids.  As I recall, the optimum for 3 was 1.75
> decades in the frequency domain.
>
> By the way, I think I have tracked down the differences between 3.5 and 3.6.
> I believe it has to do with how the sharp attenuation boundaries are
> represented.  More testing still to be done.
>
> Cheers,
> Brian
>
>
> On Jan 1, 2007, at 8:02 PM, Jeroen Tromp wrote:
>
>> Hi Dimitri:
>>
>> I think this at least worth investigating, i.e., how much more memory does
>> it take, how much flatter is the Q, how much broader is the absorption
>> band, etc.
>>
>> But we still need to fix the existing bug first....
>>
>> Jeroen
>>
>>>
>>> Dear all,
>>>
>>> By the way, talking about attenuation, now that memory is becoming less
>>> of an issue it could be clever to switch from 3 memory variables to 4
>>> (N_SLS = 4) in the global code at some point in the (near?) future. (in
>>> particular to make attenuation more precise for the dispersion of
>>> surface waves).
>>>
>>> Do you think this could be a good idea?
>>>
>>> Dimitri.
>>>

